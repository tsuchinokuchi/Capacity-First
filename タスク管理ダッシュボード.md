# 📊 タスク管理ダッシュボード

## 今日のタスク

```dataviewjs
const today = moment().format("YYYY-MM-DD");
const schedulePath = "03.ツェッテルカステン/030.データベース/タスク管理/スケジュール";
const todayFile = dv.page(`${schedulePath}/${today}`);

if (!todayFile) {
  dv.paragraph("_今日のスケジュールファイルが見つかりません_");
} else {
  const tasks = todayFile.file.tasks;
  const tasksWithTime = tasks.where(t => {
    const text = t.text;
    return text.includes("⏱️") || text.match(/\d{2}:\d{2}-\d{2}:\d{2}/);
  }).array();

  if (tasksWithTime.length === 0) {
    dv.paragraph("_今日のタスクはありません_");
  } else {
    // ジャンル設定を読み込む
    const genreConfigPath = "03.ツェッテルカステン/030.データベース/タスク管理/ジャンル設定.md";
    let genres = ["デスクワーク", "売場作業", "顧客対応", "定型作業", "学習", "健康", "趣味", "その他プライベート"]; // デフォルト
    try {
      const genreConfigContent = await dv.io.load(genreConfigPath);
      if (genreConfigContent) {
        const genreMatch = genreConfigContent.match(/const TASK_GENRES = \[([\s\S]*?)\];/);
        if (genreMatch) {
          genres = genreMatch[1]
            .split(',')
            .map(g => g.trim().replace(/^["']|["']$/g, ''))
            .filter(g => g);
        }
      }
    } catch (error) {
      console.error("ジャンル設定の読み込みエラー:", error);
    }
    
    // 容量計算
    let totalMinutes = 0;
    const genreBreakdown = {};

    tasksWithTime.forEach(task => {
      const timeMatch = task.text.match(/⏱️ (\d+)/);
      const duration = timeMatch ? parseInt(timeMatch[1]) : 0;
      totalMinutes += duration;

      // ジャンル抽出
      for (const genre of genres) {
        if (task.text.includes(`#${genre}`)) {
          genreBreakdown[genre] = (genreBreakdown[genre] || 0) + duration;
          break;
        }
      }
    });

    // タスク一覧
    dv.header(3, `📅 今日のタスク (${today})`);
    dv.table(
      ["タスク", "ジャンル", "時間", "状態"],
      tasksWithTime.map(task => {
        const timeMatch = task.text.match(/⏱️ (\d+)/);
        const duration = timeMatch ? `${timeMatch[1]}分` : "-";
        const taskName = task.text
          .replace(/⏱️ \d+/, "")
          .replace(/📅 \d{4}-\d{2}-\d{2}/, "")
          .replace(/#\w+/g, "")
          .replace(/^- \[ \] /, "")
          .replace(/^- \[x\] /, "")
          .trim();
        
        const genre = genres.find(g => task.text.includes(`#${g}`)) || "-";
        
        const status = task.completed ? "✅ 完了" : "⬜ 未完了";
        
        return [taskName, genre, duration, status];
      })
    );

    // 容量使用状況
    dv.header(4, "📊 容量使用状況");
    const usagePercent = Math.round((totalMinutes / 300) * 100);
    const usageBar = "█".repeat(Math.floor(usagePercent / 5)) + "░".repeat(20 - Math.floor(usagePercent / 5));
    dv.paragraph(`\`${totalMinutes}分 / 300分 (${usagePercent}%)\`\n${usageBar}`);
    
    if (totalMinutes > 300) {
      dv.paragraph("⚠️ **容量超過警告**: 1日の上限（300分）を超えています");
    }

    // ジャンル別構成比
    if (Object.keys(genreBreakdown).length > 0) {
      dv.header(4, "📈 ジャンル別構成比");
      dv.table(
        ["ジャンル", "時間", "構成比"],
        Object.entries(genreBreakdown)
          .sort((a, b) => b[1] - a[1])
          .map(([genre, minutes]) => [
            genre,
            `${minutes}分`,
            `${Math.round((minutes / totalMinutes) * 100)}%`
          ])
      );
    }
  }
}
```

---

## 今週のタスク

```dataviewjs
const today = moment();
const startOfWeek = moment(today).startOf('week').add(1, 'day'); // 月曜
const endOfWeek = moment(startOfWeek).add(6, 'days'); // 日曜

const schedulePath = "03.ツェッテルカステン/030.データベース/タスク管理/スケジュール";
const schedulePages = dv.pages(`"${schedulePath}"`);

// ジャンル設定を読み込む
const genreConfigPath = "03.ツェッテルカステン/030.データベース/タスク管理/ジャンル設定.md";
let genres = ["デスクワーク", "売場作業", "顧客対応", "定型作業", "学習", "健康", "趣味", "その他プライベート"]; // デフォルト
try {
  const genreConfigContent = await dv.io.load(genreConfigPath);
  if (genreConfigContent) {
    const genreMatch = genreConfigContent.match(/const TASK_GENRES = \[([\s\S]*?)\];/);
    if (genreMatch) {
      genres = genreMatch[1]
        .split(',')
        .map(g => g.trim().replace(/^["']|["']$/g, ''))
        .filter(g => g);
    }
  }
} catch (error) {
  console.error("ジャンル設定の読み込みエラー:", error);
}

let weekTasks = [];
let weekTotalMinutes = 0;
const weekGenreBreakdown = {};

for (let d = moment(startOfWeek); d.isSameOrBefore(endOfWeek); d.add(1, 'day')) {
  const dateStr = d.format("YYYY-MM-DD");
  const file = schedulePages.where(p => p.file.name === dateStr).array()[0];
  
  if (file) {
    const tasks = file.file.tasks.where(t => t.text.includes("⏱️")).array();
    tasks.forEach(task => {
      const timeMatch = task.text.match(/⏱️ (\d+)/);
      const duration = timeMatch ? parseInt(timeMatch[1]) : 0;
      weekTotalMinutes += duration;

      for (const genre of genres) {
        if (task.text.includes(`#${genre}`)) {
          weekGenreBreakdown[genre] = (weekGenreBreakdown[genre] || 0) + duration;
          break;
        }
      }

      weekTasks.push({
        date: dateStr,
        task: task.text,
        duration: duration,
        completed: task.completed
      });
    });
  }
}

dv.header(3, `📅 今週のタスク (${startOfWeek.format("MM/DD")} 〜 ${endOfWeek.format("MM/DD")})`);
if (weekTasks.length === 0) {
  dv.paragraph("_今週のタスクはありません_");
} else {
  dv.table(
    ["日付", "タスク", "時間", "状態"],
    weekTasks.map(item => {
      const taskName = item.task
        .replace(/⏱️ \d+/, "")
        .replace(/📅 \d{4}-\d{2}-\d{2}/, "")
        .replace(/#\w+/g, "")
        .replace(/^- \[ \] /, "")
        .replace(/^- \[x\] /, "")
        .trim();
      const status = item.completed ? "✅" : "⬜";
      return [item.date, taskName, `${item.duration}分`, status];
    })
  );

  dv.header(4, "📊 週間容量使用状況");
  const weekUsagePercent = Math.round((weekTotalMinutes / (300 * 5)) * 100); // 5日間想定
  dv.paragraph(`\`${weekTotalMinutes}分 / 1500分 (${weekUsagePercent}%)\``);

  if (Object.keys(weekGenreBreakdown).length > 0) {
    dv.header(4, "📈 週間ジャンル別構成比");
    dv.table(
      ["ジャンル", "時間", "構成比"],
      Object.entries(weekGenreBreakdown)
        .sort((a, b) => b[1] - a[1])
        .map(([genre, minutes]) => [
          genre,
          `${minutes}分`,
          `${Math.round((minutes / weekTotalMinutes) * 100)}%`
        ])
    );
  }
}
```

---

## タスクプール（未スケジュールタスク）

```dataviewjs
(() => {
  try {
    const poolPath = "03.ツェッテルカステン/030.データベース/タスク管理/タスクプール/タスクプール.md";
    const poolFile = dv.page(poolPath);
    
    if (!poolFile) {
      dv.paragraph("_タスクプールファイルが見つかりません_");
      return;
    }
    
    const tasks = poolFile.file.tasks;
    if (!tasks || tasks.length === 0) {
      dv.paragraph("_タスクプールに未スケジュールタスクはありません_");
      return;
    }
    
    const unscheduledTasks = [];
    for (let i = 0; i < tasks.length; i++) {
      const task = tasks[i];
      if (task && task.text) {
        const text = task.text;
        if (!text.includes("📅") && text.includes("⏱️")) {
          unscheduledTasks.push(task);
        }
      }
    }
    
    if (unscheduledTasks.length === 0) {
      dv.paragraph("_タスクプールに未スケジュールタスクはありません_");
      return;
    }
    
    dv.header(3, "📋 未スケジュールタスク");
    
    const tableRows = [];
    for (let i = 0; i < unscheduledTasks.length; i++) {
      const task = unscheduledTasks[i];
      if (!task || !task.text) continue;
      
      const timeMatch = task.text.match(/⏱️ (\d+)/);
      const duration = timeMatch ? `${timeMatch[1]}分` : "-";
      
      let taskName = task.text
        .replace(/⏱️ \d+/, "")
        .replace(/#\w+/g, "")
        .replace(/^- \[ \] /, "")
        .replace(/^- \[x\] /, "")
        .trim();
      
      const genreMatch = task.text.match(/#(\w+)/);
      const genre = genreMatch ? genreMatch[1] : "-";
      
      tableRows.push([taskName, genre, duration]);
    }
    
    if (tableRows.length > 0) {
      dv.table(["タスク", "ジャンル", "時間"], tableRows);
    }
    
    dv.paragraph("💡 **使い方**: QuickAddコマンド「タスクプールからスケジュールに移動」で日付を指定してスケジュールに移動できます");
  } catch (err) {
    dv.paragraph(`_エラー: ${err.message}_`);
    console.error("タスクプール表示エラー:", err);
  }
})();
```

---

## クイックアクション

### タスク追加
- QuickAddコマンド: 「タスク追加」
- または、[[タスクプール/タスクプール|タスクプール]]に直接追加

### タスクプールからスケジュールに移動
- QuickAddコマンド: 「タスクプールからスケジュールに移動」
- タスクプールのタスクを選択して、日付を指定してスケジュールに移動

### タスク移動
- QuickAddコマンド: 「次の日に移動」
- 出勤日リストに合わせて自動移動

### 繰り返しタスク
- [[繰り返しタスク/毎日|毎日のタスク]]
- [[繰り返しタスク/毎週|毎週のタスク]]
- [[繰り返しタスク/毎月|毎月のタスク]]

