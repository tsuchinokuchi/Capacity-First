# ğŸ“Š Capacity-first Task Dashboard

## â±ï¸ æ—¥ä»˜ã¨è‡ªå‹•æ›´æ–°

```dataviewjs
dv.span("**Today**: " + moment().format("YYYYå¹´MMæœˆDDæ—¥ï¼ˆdddï¼‰"));
```

```dataviewjs
const refreshKey = "__capacity_dashboard_refresh";
const currentDate = moment().format("YYYY-MM-DD");

if (!window[refreshKey]) {
  window[refreshKey] = { lastDate: currentDate };
  setInterval(() => {
    const latest = moment().format("YYYY-MM-DD");
    if (window[refreshKey].lastDate !== latest) {
      window[refreshKey].lastDate = latest;
      app.commands.executeCommandById('dataview:refresh-views');
    }
  }, 60 * 1000);
}

if (window[refreshKey].lastDate !== currentDate) {
  window[refreshKey].lastDate = currentDate;
  setTimeout(() => app.commands.executeCommandById('dataview:refresh-views'), 100);
}
```

---

## âš™ï¸ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

```dataviewjs
const actions = [
  { name: "â• ã‚¿ã‚¹ã‚¯è¿½åŠ ", command: "quickadd:choice:ã‚¿ã‚¹ã‚¯è¿½åŠ " },
  { name: "ğŸ“¦ ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«â†’äºˆå®š", command: "quickadd:choice:ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ç§»å‹•" },
  { name: "â¡ï¸ æ¬¡ã®æ—¥ã«ç§»å‹•", command: "quickadd:choice:ã‚¿ã‚¹ã‚¯ç§»å‹•" },
  { name: "ğŸ” ç¹°ã‚Šè¿”ã—å±•é–‹", command: "quickadd:choice:ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯å±•é–‹" }
];

const wrap = dv.container.createDiv();
wrap.style.display = "flex";
wrap.style.gap = "8px";
wrap.style.flexWrap = "wrap";

actions.forEach(act => {
  const btn = wrap.createEl("button", { text: act.name });
  btn.className = "mod-cta";
  btn.style.padding = "8px 14px";
  btn.style.cursor = "pointer";
  btn.onclick = () => {
    try {
      app.commands.executeCommandById(act.command);
    } catch (error) {
      new Notice("âŒ ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã›ã‚“ã§ã—ãŸ");
      console.error(error);
    }
  };
});
```

---

## ğŸ“ˆ ä»Šæ—¥ã®å®¹é‡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ

```dataviewjs
const CONFIG_PATH = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/config/settings.json";
const schedulePath = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«";
const genreConfigPath = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/ã‚¸ãƒ£ãƒ³ãƒ«è¨­å®š.md";

const today = moment().format("YYYY-MM-DD");
let maxDailyMinutes = 360;
let genres = ["ãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯","å£²å ´ä½œæ¥­","é¡§å®¢å¯¾å¿œ","å®šå‹ä½œæ¥­","å­¦ç¿’","å¥åº·","è¶£å‘³","ãã®ä»–ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ"];

try {
  const cfg = await dv.io.load(CONFIG_PATH);
  if (cfg) {
    const parsed = JSON.parse(cfg);
    if (Number.isFinite(parsed.maxDailyMinutes)) maxDailyMinutes = parsed.maxDailyMinutes;
  }
} catch (error) { console.error(error); }

try {
  const genreContent = await dv.io.load(genreConfigPath);
  if (genreContent) {
    const match = genreContent.match(/const TASK_GENRES = \[([\s\S]*?)\];/);
    if (match) {
      const parsed = match[1].split(',').map(g => g.trim().replace(/^["']|["']$/g,'')).filter(Boolean);
      if (parsed.length) genres = parsed;
    }
  }
} catch (error) { console.error(error); }

const todayPage = dv.page(`${schedulePath}/${today}`);
const tasks = todayPage ? todayPage.file.tasks.where(t => t.text.includes("â±ï¸")).array() : [];

let used = 0;
let remaining = 0;
const genreUsage = {};

tasks.forEach(task => {
  const m = task.text.match(/â±ï¸ (\d+)/);
  const minutes = m ? parseInt(m[1], 10) : 0;
  used += minutes;
  if (!task.completed) remaining += minutes;
  for (const genre of genres) {
    if (task.text.includes(`#${genre}`)) {
      genreUsage[genre] = (genreUsage[genre] || 0) + minutes;
      break;
    }
  }
});

const usedPct = Math.round((used / maxDailyMinutes) * 100);
const remainingPct = Math.round((remaining / maxDailyMinutes) * 100);
const bar = (pct) => {
  const filled = Math.min(20, Math.max(0, Math.floor(pct / 5)));
  return "â–ˆ".repeat(filled) + "â–‘".repeat(20 - filled);
};

if (!todayPage) {
  dv.paragraph("_ä»Šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“_");
  return;
}

dv.table(
  ["æŒ‡æ¨™", "å€¤", "ãƒãƒ¼"],
  [
    ["åˆ©ç”¨æ¸ˆã¿", `${used}åˆ† / ${maxDailyMinutes}åˆ† (${usedPct}%)`, bar(usedPct)],
    ["æœªå®Œäº†ã‚¿ã‚¹ã‚¯æ®‹", `${remaining}åˆ† / ${maxDailyMinutes}åˆ† (${remainingPct}%)`, bar(remainingPct)]
  ]
);

if (Object.keys(genreUsage).length) {
  dv.paragraph("**ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥å†…è¨³**");
  dv.table(
    ["ã‚¸ãƒ£ãƒ³ãƒ«","æ™‚é–“","å‰²åˆ"],
    Object.entries(genreUsage)
      .sort((a,b) => b[1]-a[1])
      .map(([genre, minutes]) => [genre, `${minutes}åˆ†`, `${Math.round((minutes/used)*100)||0}%`])
  );
}

if (used > maxDailyMinutes) {
  dv.paragraph("âš ï¸ **å®¹é‡è¶…é**ï¼šä»Šæ—¥ã®è¨­å®šä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™");
}
```

---

## âœ… ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯

```dataviewjs
const CONFIG_PATH = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/config/settings.json";
const schedulePath = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«";
const genreConfigPath = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/ã‚¸ãƒ£ãƒ³ãƒ«è¨­å®š.md";

const today = moment().format("YYYY-MM-DD");
let genres = ["ãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯","å£²å ´ä½œæ¥­","é¡§å®¢å¯¾å¿œ","å®šå‹ä½œæ¥­","å­¦ç¿’","å¥åº·","è¶£å‘³","ãã®ä»–ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ"];

try {
  const genreContent = await dv.io.load(genreConfigPath);
  if (genreContent) {
    const match = genreContent.match(/const TASK_GENRES = \[([\s\S]*?)\];/);
    if (match) {
      const parsed = match[1].split(',').map(g => g.trim().replace(/^["']|["']$/g,'')).filter(Boolean);
      if (parsed.length) genres = parsed;
    }
  }
} catch (error) { console.error(error); }

const todayPage = dv.page(`${schedulePath}/${today}`);
const tasks = todayPage ? todayPage.file.tasks.where(t => t.text.includes("â±ï¸")).array() : [];

const todayTasks = tasks.map(task => {
  const duration = (task.text.match(/â±ï¸ (\d+)/) || [0,0])[1];
  const cleanName = task.text
    .replace(/^- \[ \] /,'').replace(/^- \[x\] /,'')
    .replace(/â±ï¸ \d+/,'').replace(/ğŸ“… \d{4}-\d{2}-\d{2}/,'')
    .replace(/#\w+/g,'').replace(/â° \d{4}-\d{2}-\d{2}/,'')
    .trim();
  const deadlineMatch = task.text.match(/â° (\d{4}-\d{2}-\d{2})/);
  let deadlineLabel = "-";
  if (deadlineMatch) {
    const diff = moment(deadlineMatch[1]).diff(moment().startOf('day'), 'days');
    if (diff < 0) deadlineLabel = `ğŸ”´ ${deadlineMatch[1]} è¶…é`;
    else if (diff === 0) deadlineLabel = `ğŸŸ  ä»Šæ—¥ (${deadlineMatch[1]})`;
    else deadlineLabel = `â° ${deadlineMatch[1]} (ã‚ã¨${diff}æ—¥)`;
  }
  const genre = genres.find(g => task.text.includes(`#${g}`)) || "-";
  return {
    name: cleanName,
    genre,
    minutes: `${duration}åˆ†`,
    status: task.completed ? "âœ… å®Œäº†" : "â¬œ æœªå®Œäº†",
    deadline: deadlineLabel
  };
});

if (!todayTasks.length) {
  dv.paragraph("_ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“_");
} else {
  dv.table(
    ["ã‚¿ã‚¹ã‚¯","ã‚¸ãƒ£ãƒ³ãƒ«","æ™‚é–“","çŠ¶æ…‹","ç· åˆ‡"],
    todayTasks.map(t => [t.name, t.genre, t.minutes, t.status, t.deadline])
  );
  dv.paragraph(`ğŸ‘‰ [[${schedulePath}/${today}|ä»Šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é–‹ã]]`);
}
```

---

## ğŸ“… æ˜æ—¥ã®ã‚¿ã‚¹ã‚¯

```dataviewjs
const schedulePath = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«";
const genreConfigPath = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/ã‚¸ãƒ£ãƒ³ãƒ«è¨­å®š.md";

let genres = ["ãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯","å£²å ´ä½œæ¥­","é¡§å®¢å¯¾å¿œ","å®šå‹ä½œæ¥­","å­¦ç¿’","å¥åº·","è¶£å‘³","ãã®ä»–ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ"];

try {
  const genreContent = await dv.io.load(genreConfigPath);
  if (genreContent) {
    const match = genreContent.match(/const TASK_GENRES = \[([\s\S]*?)\];/);
    if (match) {
      const parsed = match[1].split(',').map(g => g.trim().replace(/^["']|["']$/g,'')).filter(Boolean);
      if (parsed.length) genres = parsed;
    }
  }
} catch (error) { console.error(error); }

const tomorrow = moment().add(1,'day').format("YYYY-MM-DD");
const tomorrowPage = dv.page(`${schedulePath}/${tomorrow}`);
if (!tomorrowPage) {
  dv.paragraph("_æ˜æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“_");
  return;
}

const tomorrowTasks = tomorrowPage.file.tasks
  .where(t => t.text.includes("â±ï¸"))
  .array()
  .map(task => {
    const duration = (task.text.match(/â±ï¸ (\d+)/) || [0,0])[1];
    const cleanName = task.text
      .replace(/^- \[ \] /,'').replace(/^- \[x\] /,'')
      .replace(/â±ï¸ \d+/,'').replace(/ğŸ“… \d{4}-\d{2}-\d{2}/,'')
      .replace(/#\w+/g,'')
      .trim();
    const genre = genres.find(g => task.text.includes(`#${g}`)) || "-";
    return [cleanName, genre, `${duration}åˆ†`, task.completed ? "âœ…" : "â¬œ"];
  });

if (!tomorrowTasks.length) {
  dv.paragraph("_æ˜æ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“_");
} else {
  dv.table(["ã‚¿ã‚¹ã‚¯","ã‚¸ãƒ£ãƒ³ãƒ«","æ™‚é–“","çŠ¶æ…‹"], tomorrowTasks);
  dv.paragraph(`ğŸ‘‰ [[${schedulePath}/${tomorrow}|æ˜æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é–‹ã]]`);
}
```

---

## ğŸ“† ä»Šé€±ã®ã‚µãƒãƒªãƒ¼

```dataviewjs
const CONFIG_PATH = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/config/settings.json";
const schedulePath = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«";

let maxDailyMinutes = 360;

try {
  const cfg = await dv.io.load(CONFIG_PATH);
  if (cfg) {
    const parsed = JSON.parse(cfg);
    if (Number.isFinite(parsed.maxDailyMinutes)) maxDailyMinutes = parsed.maxDailyMinutes;
  }
} catch (error) { console.error(error); }

const weekStart = moment().startOf('isoWeek');
const weekEnd = moment(weekStart).add(6,'days');
const pages = dv.pages(`"${schedulePath}"`);
let weeklyMinutes = 0;
let weeklyTasks = [];

for (let d = moment(weekStart); d.isSameOrBefore(weekEnd); d.add(1,'day')) {
  const dateStr = d.format("YYYY-MM-DD");
  const file = pages.where(p => p.file.name === dateStr).array()[0];
  if (!file) continue;
  file.file.tasks
    .where(t => t.text.includes("â±ï¸"))
    .array()
    .forEach(task => {
      const duration = (task.text.match(/â±ï¸ (\d+)/) || [0,0])[1];
      weeklyMinutes += parseInt(duration,10);
      const cleanName = task.text
        .replace(/^- \[ \] /,'').replace(/^- \[x\] /,'')
        .replace(/â±ï¸ \d+/,'').replace(/ğŸ“… \d{4}-\d{2}-\d{2}/,'')
        .replace(/#\w+/g,'')
        .trim();
      weeklyTasks.push([
        d.format("MM/DD(ddd)"),
        cleanName,
        `${duration}åˆ†`,
        task.completed ? "âœ…" : "â¬œ"
      ]);
    });
}

if (!weeklyTasks.length) {
  dv.paragraph("_ä»Šé€±ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“_");
} else {
  dv.table(["æ—¥ä»˜","ã‚¿ã‚¹ã‚¯","æ™‚é–“","çŠ¶æ…‹"], weeklyTasks);
  const maxWeekly = maxDailyMinutes * 5; // å¹³æ—¥ç¨¼åƒæƒ³å®š
  const pct = Math.round((weeklyMinutes / maxWeekly) * 100);
  const bar = "â–ˆ".repeat(Math.min(20, Math.floor(pct/5))) + "â–‘".repeat(Math.max(0, 20-Math.floor(pct/5)));
  dv.paragraph(`**é€±é–“å®¹é‡**: ${weeklyMinutes}åˆ† / ${maxWeekly}åˆ† (${pct}%)\n${bar}`);
}
```

---

## ğŸ—‚ ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«ï¼ˆæœªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰

```dataviewjs
(() => {
  try {
    const poolPath = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«/ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«.md";
    const poolFile = dv.page(poolPath);
    if (!poolFile) {
      dv.paragraph("_ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“_");
      return;
    }
    const poolTasks = poolFile.file.tasks
      .where(t => t.text.includes("â±ï¸") && !t.text.includes("ğŸ“…"))
      .array();
    if (!poolTasks.length) {
      dv.paragraph("_æœªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“_");
      return;
    }
    dv.table(
      ["ã‚¿ã‚¹ã‚¯","ã‚¸ãƒ£ãƒ³ãƒ«","æ™‚é–“"],
      poolTasks.map(task => {
        const duration = (task.text.match(/â±ï¸ (\d+)/) || [0,0])[1];
        const cleanName = task.text
          .replace(/^- \[ \] /,'').replace(/^- \[x\] /,'')
          .replace(/â±ï¸ \d+/,'')
          .replace(/#\w+/g,'')
          .trim();
        const genreMatch = task.text.match(/#(\w+)/);
        return [cleanName, genreMatch ? genreMatch[1] : "-", `${duration}åˆ†`];
      })
    );
    dv.paragraph("ğŸ’¡ QuickAddã€Œã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ç§»å‹•ã€ã§æ—¥ä»˜ã¸é…ç½®ã§ãã¾ã™ã€‚");
  } catch (error) {
    dv.paragraph(`_ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ_: ${error.message}`);
  }
})();
```

---

## ğŸ“ ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

- [[ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯/æ¯æ—¥|æ¯æ—¥ã®ç¹°ã‚Šè¿”ã—]]
- [[ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯/æ¯é€±|æ¯é€±ã®ç¹°ã‚Šè¿”ã—]]
- [[ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯/æ¯æœˆ|æ¯æœˆã®ç¹°ã‚Šè¿”ã—]]
- [[é€±å‹¤å‹™ã‚°ãƒªãƒƒãƒ‰|é€±å‹¤å‹™ã‚°ãƒªãƒƒãƒ‰]]
- [[ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«/ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«|ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«åŸæœ¬]]

