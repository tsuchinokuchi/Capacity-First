# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå

## æ¦‚è¦
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚

## æœŸé–“
- é–‹å§‹: YYYY-MM-DD
- çµ‚äº†: YYYY-MM-DDï¼ˆæœ€å¤§1ãƒ¶æœˆï¼‰

## é€²æ—
- [ ] 0%å®Œäº†

## ã‚µãƒ–ã‚¿ã‚¹ã‚¯ï¼ˆ1éšå±¤ã¾ã§ï¼‰

```dataviewjs
// ã‚µãƒ–ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒœã‚¿ãƒ³
const container = dv.container;
const buttonContainer = document.createElement('div');
buttonContainer.style.marginBottom = '15px';
buttonContainer.style.display = 'flex';
buttonContainer.style.gap = '10px';
buttonContainer.style.flexWrap = 'wrap';

// ã‚¸ãƒ£ãƒ³ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã‚€
const genreConfigPath = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/ã‚¸ãƒ£ãƒ³ãƒ«è¨­å®š.md";
let genres = ["ãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯", "å£²å ´ä½œæ¥­", "é¡§å®¢å¯¾å¿œ", "å®šå‹ä½œæ¥­", "å­¦ç¿’", "å¥åº·", "è¶£å‘³", "ãã®ä»–ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ"];
try {
  const genreConfigContent = await dv.io.load(genreConfigPath);
  if (genreConfigContent) {
    const genreMatch = genreConfigContent.match(/const TASK_GENRES = \[([\s\S]*?)\];/);
    if (genreMatch) {
      genres = genreMatch[1]
        .split(',')
        .map(g => g.trim().replace(/^["']|["']$/g, ''))
        .filter(g => g);
    }
  }
} catch (error) {
  console.error("ã‚¸ãƒ£ãƒ³ãƒ«è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
}

const addButton = document.createElement('button');
addButton.textContent = 'â• ã‚µãƒ–ã‚¿ã‚¹ã‚¯è¿½åŠ ';
addButton.className = 'mod-cta';
addButton.style.padding = '8px 16px';
addButton.style.cursor = 'pointer';
addButton.style.fontSize = '14px';
addButton.onclick = async () => {
  try {
    // QuickAddãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç¢ºèª
    const quickAddPlugin = app.plugins.plugins.quickadd;
    if (!quickAddPlugin || !quickAddPlugin.api) {
      new Notice('âŒ QuickAddãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    const quickAddApi = quickAddPlugin.api;
    
    const activeFile = app.workspace.getActiveFile();
    if (!activeFile) {
      new Notice('âŒ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›
    const taskName = await quickAddApi.inputPrompt(
      "ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
    );
    if (!taskName || !taskName.trim()) {
      new Notice('ã‚¿ã‚¹ã‚¯åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    // ã‚«ãƒ†ã‚´ãƒªï¼ˆã‚¸ãƒ£ãƒ³ãƒ«ï¼‰ã‚’é¸æŠ
    const selectedGenre = await quickAddApi.suggester(
      genres,
      genres,
      "ã‚«ãƒ†ã‚´ãƒªï¼ˆã‚¸ãƒ£ãƒ³ãƒ«ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„"
    );
    if (!selectedGenre) {
      new Notice('ã‚«ãƒ†ã‚´ãƒªãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    // æ‰€è¦æ™‚é–“ã‚’å…¥åŠ›
    const duration = await quickAddApi.inputPrompt(
      "æ‰€è¦æ™‚é–“ï¼ˆåˆ†ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
      "60"
    );
    if (!duration || !duration.trim()) {
      new Notice('æ‰€è¦æ™‚é–“ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    // å®Ÿæ–½æ—¥ã‚’å…¥åŠ›
    const today = moment().format("YYYY-MM-DD");
    const scheduleDate = await quickAddApi.inputPrompt(
      "å®Ÿæ–½æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (YYYY-MM-DD)",
      today
    );
    if (!scheduleDate || !scheduleDate.trim()) {
      new Notice('å®Ÿæ–½æ—¥ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    const scheduleDateMoment = moment(scheduleDate.trim(), "YYYY-MM-DD");
    if (!scheduleDateMoment.isValid()) {
      new Notice('ç„¡åŠ¹ãªæ—¥ä»˜å½¢å¼ã§ã™ã€‚YYYY-MM-DDå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    const scheduleDateStr = scheduleDateMoment.format("YYYY-MM-DD");
    
    // ç· åˆ‡æ—¥ã‚’å…¥åŠ›ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    const deadlineInput = await quickAddApi.inputPrompt(
      "ç· åˆ‡æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (YYYY-MM-DD) - ç©ºç™½ã®å ´åˆã¯ç· åˆ‡ãªã—",
      ""
    );
    
    let deadlineStr = "";
    if (deadlineInput && deadlineInput.trim()) {
      const deadlineMoment = moment(deadlineInput.trim(), "YYYY-MM-DD");
      if (deadlineMoment.isValid()) {
        deadlineStr = ` â° ${deadlineMoment.format("YYYY-MM-DD")}`;
      } else {
        new Notice("ç„¡åŠ¹ãªç· åˆ‡æ—¥å½¢å¼ã§ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™");
      }
    }
    
    // ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠï¼ˆæ—¢å­˜ã®ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—ï¼‰
    let projectContent = await app.vault.read(activeFile);
    const subtaskMatches = projectContent.matchAll(/^### (.+)$/gm);
    const existingSubtasks = Array.from(subtaskMatches).map(m => m[1]).filter(s => s !== 'æ¦‚è¦' && s !== 'æœŸé–“' && s !== 'é€²æ—' && s !== 'ã‚µãƒ–ã‚¿ã‚¹ã‚¯ï¼ˆ1éšå±¤ã¾ã§ï¼‰' && s !== 'ãƒ¡ãƒ¢');
    
    let subtaskCategory;
    if (existingSubtasks.length > 0) {
      subtaskCategory = await quickAddApi.suggester(
        [...existingSubtasks, 'æ–°è¦ã‚«ãƒ†ã‚´ãƒª'],
        [...existingSubtasks, 'æ–°è¦ã‚«ãƒ†ã‚´ãƒª'],
        "ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆã¾ãŸã¯æ–°è¦ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆï¼‰"
      );
      
      if (!subtaskCategory) {
        new Notice('ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      if (subtaskCategory === 'æ–°è¦ã‚«ãƒ†ã‚´ãƒª') {
        subtaskCategory = await quickAddApi.inputPrompt(
          "æ–°ã—ã„ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
        );
        if (!subtaskCategory || !subtaskCategory.trim()) {
          new Notice('ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªåãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }
      }
    } else {
      subtaskCategory = await quickAddApi.inputPrompt(
        "ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
      );
      if (!subtaskCategory || !subtaskCategory.trim()) {
        new Notice('ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªåãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
    }
    
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å–å¾—ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ‹¡å¼µå­ã‚’é™¤ãï¼‰
    const projectName = activeFile.basename;
    
    // ã‚¿ã‚¹ã‚¯è¡Œã‚’ä½œæˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¿½åŠ ï¼‰
    const taskLine = `- [ ] ${taskName.trim()} #${selectedGenre} â±ï¸ ${duration.trim()} ğŸ“… ${scheduleDateStr}${deadlineStr} ğŸ”— ${projectName}`;
    
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ 
    const subtaskHeader = `### ${subtaskCategory.trim()}`;
    const subtaskSectionIndex = projectContent.indexOf('## ã‚µãƒ–ã‚¿ã‚¹ã‚¯ï¼ˆ1éšå±¤ã¾ã§ï¼‰');
    
    if (subtaskSectionIndex === -1) {
      new Notice('âŒ ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’å–å¾—
    const afterSubtaskSection = projectContent.substring(subtaskSectionIndex);
    const nextSectionIndex = afterSubtaskSection.indexOf('\n## ');
    const subtaskSection = nextSectionIndex !== -1 
      ? afterSubtaskSection.substring(0, nextSectionIndex)
      : afterSubtaskSection;
    
    // æ—¢å­˜ã®ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚‹ã‹ç¢ºèª
    const categoryHeaderRegex = new RegExp(`^### ${subtaskCategory.trim()}$`, 'm');
    const categoryMatch = subtaskSection.match(categoryHeaderRegex);
    
    if (categoryMatch) {
      // æ—¢å­˜ã®ã‚«ãƒ†ã‚´ãƒªã«è¿½åŠ 
      const categoryIndex = subtaskSection.indexOf(categoryMatch[0]);
      const afterCategory = subtaskSection.substring(categoryIndex);
      const nextCategoryIndex = afterCategory.indexOf('\n### ');
      const categoryEndIndex = nextCategoryIndex !== -1 
        ? categoryIndex + nextCategoryIndex
        : subtaskSection.length;
      
      const categoryContent = subtaskSection.substring(categoryIndex, categoryEndIndex);
      const lastTaskIndex = categoryContent.lastIndexOf('- [');
      
      if (lastTaskIndex !== -1) {
        // æœ€å¾Œã®ã‚¿ã‚¹ã‚¯ã®å¾Œã«è¿½åŠ 
        const insertIndex = categoryContent.indexOf('\n', lastTaskIndex);
        const newCategoryContent = categoryContent.substring(0, insertIndex) + '\n' + taskLine + categoryContent.substring(insertIndex);
        projectContent = projectContent.substring(0, subtaskSectionIndex + categoryIndex) + newCategoryContent + projectContent.substring(subtaskSectionIndex + categoryEndIndex);
      } else {
        // ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ã®ç›´å¾Œã«è¿½åŠ 
        const headerEndIndex = categoryContent.indexOf('\n');
        const newCategoryContent = categoryContent.substring(0, headerEndIndex + 1) + taskLine + '\n' + categoryContent.substring(headerEndIndex + 1);
        projectContent = projectContent.substring(0, subtaskSectionIndex + categoryIndex) + newCategoryContent + projectContent.substring(subtaskSectionIndex + categoryEndIndex);
      }
    } else {
      // æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆ
      const subtaskSectionEnd = subtaskSectionIndex + subtaskSection.length;
      const newCategory = `\n\n${subtaskHeader}\n${taskLine}\n`;
      projectContent = projectContent.substring(0, subtaskSectionEnd) + newCategory + projectContent.substring(subtaskSectionEnd);
    }
    
    await app.vault.modify(activeFile, projectContent);
    
    // å®Ÿæ–½æ—¥ã®ãƒãƒ¼ãƒˆã«ã‚‚è¿½åŠ 
    const schedulePath = "03.ãƒ„ã‚§ãƒƒãƒ†ãƒ«ã‚«ã‚¹ãƒ†ãƒ³/030.ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹/ã‚¿ã‚¹ã‚¯ç®¡ç†/ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«";
    const scheduleFilePath = `${schedulePath}/${scheduleDateStr}.md`;
    let scheduleFile = app.vault.getAbstractFileByPath(scheduleFilePath);
    
    if (!scheduleFile) {
      scheduleFile = await app.vault.create(scheduleFilePath, `## ä»Šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«\n\n`);
    }
    
    let scheduleContent = await app.vault.read(scheduleFile);
    
    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
    if (!scheduleContent.includes(taskLine)) {
      scheduleContent += taskLine + '\n';
      await app.vault.modify(scheduleFile, scheduleContent);
    }
    
    new Notice(`âœ… ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${subtaskCategory.trim()}ã€å®Ÿæ–½æ—¥: ${scheduleDateStr}ï¼‰`);
    
    // ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    setTimeout(() => {
      app.commands.executeCommandById('dataview:refresh-views');
    }, 500);
  } catch (error) {
    new Notice('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
    console.error(error);
  }
};

buttonContainer.appendChild(addButton);
container.appendChild(buttonContainer);
```

### ã‚µãƒ–ã‚¿ã‚¹ã‚¯1
- [ ] ã‚¿ã‚¹ã‚¯1 #ã‚¸ãƒ£ãƒ³ãƒ« â±ï¸ 60 ğŸ“… YYYY-MM-DD
- [ ] ã‚¿ã‚¹ã‚¯2 #ã‚¸ãƒ£ãƒ³ãƒ« â±ï¸ 60 ğŸ“… YYYY-MM-DD

### ã‚µãƒ–ã‚¿ã‚¹ã‚¯2
- [ ] ã‚¿ã‚¹ã‚¯3 #ã‚¸ãƒ£ãƒ³ãƒ« â±ï¸ 60 ğŸ“… YYYY-MM-DD

## ãƒ¡ãƒ¢
<!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚„æ³¨æ„äº‹é …ã‚’è¨˜å…¥ -->

